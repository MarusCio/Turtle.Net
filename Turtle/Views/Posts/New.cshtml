@model Turtle.Models.PostForm


<h2 class="text-center mt-5">Create Post</h2>

<br />


<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">

            <div class="card turtle-card p-4">

                <h2 class="text-center turtle-title mb-4">
                    🐢 Create a new post
                </h2>

                <form enctype="multipart/form-data"  method="post" asp-action="New" asp-controller="Posts">
                    <div class="mb-3">
                        <label asp-for="Title" class="form-label">Post Title</label>
                        <br />
                        <input asp-for="Title" class="form-control turtle-input" required />

                        <!-- Mesaj de validare pentru titlu -->
                        <span asp-validation-for="Title" class="text-danger"></span>

                        <br /><br />
                    </div>

                    <div class="mb-3">
                        <label asp-for="Content" class="form-label">Post Content</label>
                        <br />
                        <textarea asp-for="Content" class="form-control turtle-input"></textarea>

                        <!-- Mesaj de validare pentru continut -->
                        <span asp-validation-for="Content" class="text-danger"></span>

                        <br /><br />
                    </div>

                
                    <div class="mb-4">
                        <button type="button" class="btn turtle-btn-outline" id="suggestBtn">🤖 Suggest Categories by Gemini</button>
                    </div>

                    <div class="mb-4">
                        <label for="SelectedCategoryId">Choose Categories</label>
                        <br />

                        <div class="tutle-category-box">
                            @foreach (var cat in Model.AvailableCategories)
                            {
                                <div class="form-check">
                                    <input type="checkbox"
                                           name="SelectedCategoryIds"
                                           value="@cat.Value"
                                           class="form-check-input" />
                                    <label class="form-check-label">@cat.Text</label>
                                </div>
                            }
                        </div>
                        <br />
                    </div>

                    @if (ViewBag.FromCommunity == true)
                    {
                        <!-- venim din /Communities/Show -->
                        <input type="hidden" asp-for="CommunityId" />
                    }
                    else
                    {
                        <div class="mb-4">
                            <label asp-for="CommunityId" class="form-label">Choose Community</label>
                            <br />
                            <select asp-for="CommunityId"
                                    asp-items="Model.AvailableCommunities"
                                    class="form-control tutle-input">
                                <option value="">Choose Community</option>
                            </select>

                            <span asp-validation-for="CommunityId" class="text-danger"></span>
                            <br />
                        </div>
                    }

                    <div class="mb-4">
                        <label for="Files">Add Files</label>
                        <input asp-for="Files" type="file" multiple class="form-control turtle-input" />

                        <!-- Mesaj de validare pentru imagine -->
                        <span asp-validation-for="Files" class="text-danger"></span>
                    </div>

                    <br />


                    <div class="d-flex justify-content-between">
                        <a asp-controller="Posts"
                           asp-action="Index"
                           class="btn turtle-btn-outline">
                            Cancel
                        </a>

                        <button class="btn turtle-btn-primary" type="submit">Add Post</button>

                    </div>

                </form>
            </div>
        </div>
    </div>
</div>

<script>
    document.getElementById("suggestBtn").addEventListener("click", async () => {
        const title = document.querySelector('input[name="Title"]').value;
        const content = document.querySelector('textarea[name="Content"]').value;

        const response = await fetch('/Posts/SuggestCategories', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title, content })
        });

        const data = await response.json();

        // Check checkboxes for suggested categories
        document.querySelectorAll('input[name="SelectedCategoryIds"]').forEach(cb => {
            cb.checked = data.categories.includes(cb.nextElementSibling.innerText);
        });
    });
</script>
