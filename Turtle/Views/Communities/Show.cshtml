@model Turtle.Models.Community

<br />

<div class="turtle-community-header">
        <img src="@(Model.ImageUrl ?? "/images/communities/default.jpeg")"
             class="turtle-community-avatar" />

    <div class="turtle-community-info">
        <h2>@Model.CommunityName</h2>
        <small>Created by @Model.Creator.UserName</small>

        @if (!string.IsNullOrEmpty(Model.Description))
        {
            <p> @Model.Description </p>
        }
        else
        {
            <p> No description available </p>
        }

       </div>
</div>

        @if (User.Identity.IsAuthenticated && ViewBag.IsMember)
        {
            <a class="btn btn-success"
               asp-controller="Posts"
               asp-action="New"
               asp-route-communityId="@Model.Id">
                Create Post
            </a>
        }

        @if (User.Identity.IsAuthenticated && ViewBag.IsMember == true && ViewBag.CurrentRole == CommunityRole.Admin)
        {
            <a class="btn btn-secondary"
               asp-controller="Communities"
               asp-action="Edit"
               asp-route-id="@Model.Id">
                Edit Community
            </a>
        }

        @if (User.Identity.IsAuthenticated && ViewBag.IsMember == true && ViewBag.CurrentRole == CommunityRole.Admin)
        {
            <form method="post" asp-action="DeleteCommunity" asp-route-id="@Model.Id" class="d-inline">
                <button type="submit" class="btn btn-warning text-dark">
                    Delete Community
                </button>
            </form>
        }

        @if (User.Identity.IsAuthenticated && ViewBag.IsMember == false)
        {
            <form method="post" asp-action="Join" asp-route-communityId="@Model.Id" class="d-inline">
                <button type="submit" class="btn btn-success">
                    Join Community
                </button>
            </form>
        }

        @if (User.Identity.IsAuthenticated && ViewBag.IsMember == true)
        {
            <form method="post" asp-action="Leave" asp-route-communityId="@Model.Id" class="d-inline">
                <button type="submit" class="btn btn-danger">
                    Leave Community
                </button>
            </form>
        }

       


        

        <hr />

        <!--meniu tauri-->
        <ul class="nav nav-tabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" data-bs-toggle="tab"
                        data-bs-target="#TabPostari" type="button" role="tab">
                    Posts
                </button>
            </li>

            <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab"
                        data-bs-target="#TabMembrii" type="button" role="tab">
                    Members
                </button>
            </li>
        </ul>

        
        <div class="tab-content mt-3">

            <!--tabul pt postari-->
            <div class="tab-pane fade @(ViewBag.ActiveTab == "posts" ? "show active" : "")" id="TabPostari">
                <h3>Posts in this community</h3>

                @if (ViewBag.Posts == null || ((List<Turtle.Models.Post>)ViewBag.Posts).Count == 0)
                {
                    <p>This community has no posts yet</p>
                }
                else
                {
                    <!--search posts-->
                    <form method="get" class="turtle-filters">
                        <input type="hidden" name="id" value="@Model.Id" />
                        <input type="hidden" name="tab" value="posts" />

                        <input type="text"
                               name="searchPosts"
                               class="form-control turtle-filter-search"
                               placeholder="Search posts..."
                               value="@ViewBag.SearchPosts" />

                        <select name="sortPosts"
                                class="form-select turtle-filter-sort">
                            <option value="recent" selected="@(ViewBag.SortPosts == "recent")">
                                Most recent
                            </option>
                            <option value="popular" selected="@(ViewBag.SortPosts == "popular")">
                                Popular
                            </option>
                            <option value="oldest" selected="@(ViewBag.SortPosts == "oldest")">
                                Oldest
                            </option>
                        </select>

                        <button class="btn turtle-btn-outline turtle-filter-btn">
                            Apply
                        </button>
                    </form>


                    foreach (var post in ViewBag.Posts)
                    {
                        <div class="card turtle-post-card mb-3">
                            <div class="card-body">
                                <partial name="PostShortInfo" model="post" />
                            </div>
                        </div>
                    }
                }

                <!--paginare postari-->
                @if (ViewBag.PostsLastPage > 1)
                {
                    <nav>
                        <ul class="pagination justify-content-center">
                            @for (int i = 1; i <= ViewBag.PostsLastPage; i++)
                            {
                                <li class="page-item @(ViewBag.PostsCurrentPage == i ? "active" : "")">
                                    <a class="page-link"
                                       href="/Communities/Show/@Model.Id?tab=posts&pagePosts=@i&sortPosts=@ViewBag.SortPosts&searchPosts=@ViewBag.SearchPosts">
                                        @i                                        
                                    </a>
                                </li>
                            }
                        </ul>
                    </nav>
                }



            </div>

            <!--tabul pt membrii-->
            <div class="tab-pane fade @(ViewBag.ActiveTab == "members" ? "show active" : "")" id="TabMembrii">
                <!-- DEBUG INFO -->
                @* <p style="color:red">
                    Debug:<br />
                    Logged: @User.Identity.IsAuthenticated <br />
                    IsMember: @ViewBag.IsMember <br />
                    CurrentRole: @ViewBag.CurrentRole
                </p> *@


                <!--search members-->
                <form method="get" class="turtle-filters mb-3">
                    <input type="hidden" name="tab" value="members" />
                    <input type="text"
                           name="searchMembers"
                           class="form-control turtle-filter-search"
                           placeholder="Search by name or role"
                           value="@ViewBag.SearchMembers" />

                    <button class="btn turtle-btn-outline">Search</button>
                </form>



                @foreach (var member in ViewBag.Members)
                {
            <div class="turtle-member-card">

                <div class="turtle-member-main">
                    <div class="turtle-member-info">
                        <strong>@member.User.UserName</strong>

                        <span class="turtle-role-badge @member.Role.ToString().ToLower()">
                            @member.Role
                        </span>
                    </div>

                    @if (User.Identity.IsAuthenticated && ViewBag.IsMember)
                    {
                        CommunityRole currentRole = ViewBag.CurrentRole;
                        bool canModify = false;

                        if (currentRole == CommunityRole.Admin)
                            canModify = true;
                        else if (currentRole == CommunityRole.Moderator && member.Role == CommunityRole.Member)
                            canModify = true;

                        if (canModify && member.UserId != ViewBag.CurrentUserId)
                        {
                            <div class="turtle-member-actions">

                                @if (currentRole == CommunityRole.Admin && member.Role == CommunityRole.Member)
                                {
                                    <form method="post" asp-action="ChangeRole" class="d-inline">
                                        <input type="hidden" name="userCommunityId" value="@member.Id" />
                                        <input type="hidden" name="newRole" value="Moderator" />
                                        <button class="btn turtle-btn-outline-sm">
                                            Make Moderator
                                        </button>
                                    </form>
                                }

                                <form method="post" asp-action="KickMember" class="d-inline">
                                    <input type="hidden" name="userCommunityId" value="@member.Id" />
                                    <button class="btn turtle-btn-danger-sm">
                                        Kick
                                    </button>
                                </form>
                            </div>
                        }
                    }
                </div>

                <small class="turtle-member-meta">
                    Joined: @member.JoinedAt
                </small>

            </div>
                }


                @if (ViewBag.MembersLastPage > 1)
                {
                    <nav>
                        <ul class="pagination justify-content-center">
                            @for (int i = 1; i <= ViewBag.MembersLastPage; i++)
                            {
                                <li class="page-item @(ViewBag.MembersCurrentPage == i ? "active" : "")">
                                    <a class="page-link"
                                       href="/Communities/Show/@Model.Id?tab=members&pageMembers=@i">
                                        @i
                                    </a>
                                </li>
                            }
                        </ul>
                    </nav>
                }


            </div>

        </div>

    </div>
</div>

<br />
<br />

