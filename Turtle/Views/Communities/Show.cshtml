@model Turtle.Models.Community

<br />

<div class="card">
    <div class="container mt-4">
        <h2>@Model.CommunityName</h2>

        <p>Created by: @Model.Creator.UserName</p>

        @if (User.Identity.IsAuthenticated && ViewBag.IsMember == true && ViewBag.CurrentRole == CommunityRole.Admin)
        {
            <a class="btn btn-secondary"
               asp-controller="Communities"
               asp-action="Edit"
               asp-route-id="@Model.Id">
                Edit Community
            </a>
        }

        @if (User.Identity.IsAuthenticated && ViewBag.IsMember == true && ViewBag.CurrentRole == CommunityRole.Admin)
        {
            <form method="post" asp-action="DeleteCommunity" asp-route-id="@Model.Id" class="d-inline">
                <button type="submit" class="btn btn-warning text-dark">
                    Delete Community
                </button>
            </form>
        }

        @if (User.Identity.IsAuthenticated && ViewBag.IsMember == false)
        {
            <form method="post" asp-action="Join" asp-route-communityId="@Model.Id" class="d-inline">
                <button type="submit" class="btn btn-success">
                    Join Community
                </button>
            </form>
        }

        @if (User.Identity.IsAuthenticated && ViewBag.IsMember == true)
        {
            <form method="post" asp-action="Leave" asp-route-communityId="@Model.Id" class="d-inline">
                <button type="submit" class="btn btn-danger">
                    Leave Community
                </button>
            </form>
        }

        

        <hr />

        <!--meniu tauri-->
        <ul class="nav nav-tabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" data-bs-toggle="tab"
                        data-bs-target="#TabPostari" type="button" role="tab">
                    Posts
                </button>
            </li>

            <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab"
                        data-bs-target="#TabMembrii" type="button" role="tab">
                    Members
                </button>
            </li>
        </ul>

        
        <div class="tab-content mt-3">

            <!--tabul pt postari-->
            <div class="tab-pane fade show active" id="TabPostari" role="tabpanel">
                <h3>Posts in this community</h3>

                @if (!Model.PostsCommunity.Any())
                {
                    <p>This community has no posts yet</p>
                }
                else
                {
                    foreach (var post in Model.PostsCommunity)
                    {
                        <div class="card mb-3">
                            <div class="card-body">
                                <partial name="PostShortInfo" model="post" />
                            </div>
                        </div>
                    }
                }
            </div>

            <!--tabul pt membrii-->
            <div class="tab-pane fade" id="TabMembrii" role="tabpanel">

                <!-- DEBUG INFO -->
                @* <p style="color:red">
                    Debug:<br />
                    Logged: @User.Identity.IsAuthenticated <br />
                    IsMember: @ViewBag.IsMember <br />
                    CurrentRole: @ViewBag.CurrentRole
                </p> *@

                @foreach (var member in Model.UserCommunities)
                {
                    <div class="card mb-2 p-2">

                        <b>@member.User.UserName</b>
                        <span class="badge bg-secondary">@member.Role</span>

                        @if (User.Identity.IsAuthenticated && ViewBag.IsMember)
                        {
                            CommunityRole currentRole = ViewBag.CurrentRole;
                            bool canModify = false;


                            // Admin poate modifica pe oricine
                            if (currentRole == CommunityRole.Admin)
                            {
                                canModify = true;
                            }

                            // Moderator poate modifica doar membri
                            else if (currentRole == CommunityRole.Moderator && member.Role == CommunityRole.Member)
                            {
                                canModify = true;
                            }


                            // Nu se poate modifica propriului rol
                            if (canModify && member.UserId != ViewBag.CurrentUserId)
                            {
                                <div class="mt-2">


                                    @if (currentRole == CommunityRole.Admin)
                                    {
                                        if (member.Role == CommunityRole.Member)
                                        {
                                            <form method="post" asp-controller="Communities" asp-action="ChangeRole" class="d-inline">
                                                <input type="hidden" name="userCommunityId" value="@member.Id" />
                                                <input type="hidden" name="newRole" value="Moderator" />
                                                <button type="submit" class="btn btn-sm btn-outline-warning"> Make Moderator </button>
                                            </form>
                                        }

                                        else if (member.Role == CommunityRole.Moderator)
                                        {
                                            <form method="post" asp-controller="Communities" asp-action="ChangeRole" class="d-inline">
                                                <input type="hidden" name="userCommunityId" value="@member.Id" />
                                                <input type="hidden" name="newRole" value="Member" />
                                                <button type="submit" class="btn btn-sm btn-outline-warning"> Make member </button>
                                            </form>
                                        }
                                    }

                                    else if (currentRole == CommunityRole.Moderator && member.Role == CommunityRole.Member)
                                    {
                                        <form method="post" asp-controller="Communities" asp-action="ChangeRole" class="d-inline">

                                            <input type="hidden" name="userCommunityId" value="@member.Id" />
                                            <input type="hidden" name="newRole" value="Moderator" />

                                            <button type="submit" class="btn btn-sm btn-outline-warning"> Make Moderator </button>
                                        </form>
                                    }


                                    <form method="post" asp-controller="Communities" asp-action="KickMember" class="d-inline">

                                        <input type="hidden" name="userCommunityId" value="@member.Id" />

                                        <button type="submit" class="btn btn-sm btn-danger"> Kick </button>
                                    </form>

                                </div>
                            }

                        }

                        <br />
                        <small>Joined: @member.JoinedAt</small>
                    </div>
                }
            </div>

        </div>

</div>


<br />
<br />

